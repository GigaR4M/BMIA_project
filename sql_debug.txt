
--- get_start_of_year ---
CREATE OR REPLACE FUNCTION public.get_start_of_year()
 RETURNS timestamp with time zone
 LANGUAGE sql
 IMMUTABLE
AS $function$
  SELECT DATE_TRUNC('year', NOW() AT TIME ZONE 'America/Sao_Paulo') AT TIME ZONE 'America/Sao_Paulo';
$function$


--- get_leaderboard ---
CREATE OR REPLACE FUNCTION public.get_leaderboard(p_guild_id bigint, p_limit integer DEFAULT 50, p_days integer DEFAULT NULL::integer, p_start_date timestamp with time zone DEFAULT NULL::timestamp with time zone)
 RETURNS TABLE(rank bigint, user_id text, username text, discriminator text, total_points bigint)
 LANGUAGE sql
 SET search_path TO 'public'
AS $function$
  SELECT
    RANK() OVER (ORDER BY SUM(ip.points) DESC)::BIGINT as rank,
    u.user_id::TEXT,
    u.username,
    u.discriminator,
    SUM(ip.points)::BIGINT as total_points
  FROM users u
  INNER JOIN interaction_points ip ON u.user_id = ip.user_id
  WHERE 
    u.is_bot = FALSE
    -- Global View (Matches Highlights behavior which works)
    AND (
      (p_start_date IS NOT NULL AND ip.created_at >= p_start_date)
      OR
      (p_start_date IS NULL AND (p_days IS NULL OR ip.created_at >= NOW() - (p_days || ' days')::INTERVAL))
    )
  GROUP BY u.user_id, u.username, u.discriminator
  ORDER BY total_points DESC
  LIMIT p_limit;
$function$


--- get_dashboard_stats ---
Function get_dashboard_stats not found.
